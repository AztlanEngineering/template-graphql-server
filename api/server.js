!function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=17)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("validator")},function(e,t){e.exports=require("apollo-errors")},function(e,t){e.exports=require("bcrypt")},function(e,t){e.exports=require("request-promise")},function(e,t){e.exports=require("apollo-server")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("passport")},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("passport-jwt")},function(e,t){e.exports=require("graphql-tools")},function(e,t){e.exports=require("query-string")},function(e,t){e.exports=require("apollo-server-express")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("apollo-cache-control")},function(e,t,n){e.exports=n(18)},function(e,t,n){"use strict";n.r(t);n(10);var r=n(0),a=n.n(r);const s=new a.a.Schema({access_token:String,refresh_token:String,provider:String,picture:String,email:String,email_verified:Boolean,locale:String,name:String,scope:String,ts_created:{type:Date,default:Date.now},ts_updated:{type:Date,default:Date.now},expires:{type:Date}}),o=new a.a.Schema({email:String,first_name:String,last_name:String,ts_created:{type:Date,default:Date.now},ts_updated:{type:Date},username:String,password:String,handle:String,profile_picture:String,superuser:Boolean,operator:Boolean,is_active:Boolean,oauth2:[s]});var i=a.a.model("users",o);const u=new a.a.Schema({token:String,maxAge:{type:String,default:"3600"},user:{type:a.a.Schema.Types.ObjectId,ref:"User"}});var c=new a.a.model("token",u);const l=n(11).Strategy,d=n(11).ExtractJwt,p={};p.jwtFromRequest=d.fromAuthHeaderAsBearerToken(),p.secretOrKey=process.env.JWT_SECRET,p.issuer="",p.audience="",p.authScheme="Bearer",p.algorithms=["HS512"];var h=new l(p,(e,t)=>{"true"===process.env.DEBUG&&console.log("TOKEN INFORMATION",e),i.findById(e.id).then(e=>t(null,e||!1)).catch(e=>console.error(e))}),g=n(12);var m=[...["type Query {\n  _empty: String\n}\nenum CacheControlScope {\n  PUBLIC\n  PRIVATE\n}\n\ndirective @cacheControl (\n  maxAge: Int\n  scope: CacheControlScope\n) on FIELD_DEFINITION | OBJECT | INTERFACE\n","type Mutation {\n  _empty: String\n}\n"],...["type Token {\n  token: String!\n  maxAge: String!\n}\n\n","extend type Query {\n \tallUsers: [User]!\n \tuser(id:ID!): User\n \tme: User\n  hello: String!\n}\n\nextend type Mutation {\n \taddUser(input:UserInput): User!,\n \tupdateUser(id: ID!, input:UserInput): User!,\n \tupdateMe(input:MeInput): User!,\n \tdeleteUser(id: ID!): Boolean!,\n \tchangePassword(id: ID!, password: String!): Boolean!,\n \tchangeMyPassword(password: String!): Boolean!,\n \tlogin(input: UserLogin): Token!,\n  signup(input: UserInput): Token!,\n}\n\ninput UserInput {\n  first_name: String\n  last_name: String\n  email: String\n  username: String\n  password: String\n  superuser: Boolean\n  operator: Boolean\n  handle: String\n  profile_picture: String\n  is_active:Boolean\n}\n\ninput MeInput {\n  first_name: String\n  last_name: String\n  email: String\n  username: String\n  password: String\n  handle: String\n  profile_picture: String\n}\n\ninput UserLogin {\n  email: String!\n  password:String!\n}\n\ntype User {\n \tid: ID\n \tts_created: String\n \tts_updated: String\n \tfirst_name: String\n \tlast_name: String\n \temail: String\n  username: String\n  superuser: Boolean\n  operator: Boolean\n  password: String\n  handle: String\n  profile_picture: String\n  is_active:Boolean\n}\n\ntype MinUser {\n \tid: ID\n \tfirst_name: String\n \tlast_name: String\n  username: String\n  handle: String\n  profile_picture: String\n  is_active:Boolean\n}\n\n",""],...["# Generator version : 1.1.1\nextend type Query {\n  getHello: Hello\n}\n\n#extend type Mutation {\n  #mutateHello(id: ID!, input: HelloInput!): Hello!\n  # }\n\n#input HelloInput {\n  #y:String\n# }\n\ntype Hello {\n  y:String\n}\n",""],...["# Generator version : 1.1.2\nextend type Query {\n  oAuth2Google: String!\n}\n\nextend type Mutation {\n  oAuth2Login(code:String): Token!\n}\n","# Generator version : 1.1.1\nextend type Query {\n  allSetters: [Setter]\n  getSetter: Setter\n  #paginatedSetter (page:Int, category: String):PaginatedSetters\n}\n\nextend type Mutation {\n  addSetter(input:SetterInput!): Setter!\n  updateSetter(id: ID!, input: SetterInput!): Setter!\n  deleteSetter(id: ID!): Boolean!\n  }\n\ninput SetterInput {\n  user:String\n  s:String\n  provider:String\n  }\n\ntype Setter {\n  id:ID\n  user:User\n  s:String\n  provider:String\n  expires:Int\n  ts_created:Int\n  is_valid:Boolean\n}\n\n#type PaginatedSetters {\n#  docs: [Setter]\n#  totalDocs: Int!\n#  limit: Int!\n#  hasPrevPage: Boolean!\n#  hasNextPage: Boolean!\n#  page: Int!\n#  totalPages: Int!\n#  pagingCounter: Int!\n#  prevPage: Int\n#  nextPage: Int\n#}\n",""]],f=n(3),w=n.n(f),y=n(1),S=n.n(y),_=n(2),v=Object(_.createError)("ConfigurationError",{message:"There is a problem with the current software configuration."}),x=Object(_.createError)("NotUniqueError",{message:"One of the required fields should be unique"});var U=Object(_.createError)("ObjectNotFoundError",{message:"Object not found",options:{showPath:!1,showLocations:!1}}),E=Object(_.createError)("ValidationError",{message:"The provided data is not valid."}),I=n(5);var O=function(e,t){if(t)return e;throw new I.AuthenticationError},k=e=>null==e||"object"==typeof e&&0===Object.keys(e).length||"string"==typeof e&&0===e.trim().length;var T=n(6),D=n.n(T);var b=e=>{if(!process.env.JWT_SECRET)throw new v({message:"No jwt secret key"});return((e,t=null)=>{const n={id:e.id,username:e.username},r=t,a=D.a.sign(n,r,{issuer:"Meccamico",subject:e.id,audience:"dashboard.meccamico.com",expiresIn:Number(process.env.SESSION_DURATION),algorithm:"HS512"});return new c({maxAge:Number(process.env.SESSION_DURATION),token:a,user:e._id}).save()})(e,process.env.JWT_SECRET)};var P={add:(e,t)=>new i(t).save(),del:async(e,t)=>(await i.deleteOne({_id:t},e=>{if(e)return!1}),!0),changePassword:async(e,t)=>{const n=await w.a.genSalt(10),r=await w.a.hash(t.password,n);if(await i.findByIdAndUpdate(t.id,{password:r}))return!0;throw new U},changeMyPassword:async(e,t,n)=>{const r=await w.a.genSalt(10),a=await w.a.hash(t.password,r);if(await i.findByIdAndUpdate(n.user.id,{password:a}))return!0;throw new U},updateMe:async(e,t,n)=>{const r={...t.input};r.ts_updated=Date.now();const a=await i.findByIdAndUpdate(n.user.id,{$set:r});if(a)return a;throw new U},update:async(e,t)=>{const n={...t.input};n.ts_updated=Date.now();const r=await i.findByIdAndUpdate(t.id,{$set:n});if(r)return r;throw new U},users:(e,t)=>i.find({}),user:e=>i.find({token:e}),signup:async(e,t,n)=>{const{errors:r,isValid:a}=function(e){let t={};return e.last_name=k(e.last_name)?"":e.last_name,e.username=k(e.username)?"":e.username,e.first_name=k(e.first_name)?"":e.first_name,e.email=k(e.email)?"":e.email,e.password=k(e.password)?"":e.password,S.a.isLength(e.first_name,{min:2,max:30})||(t.first_name="First name must be between 2 to 30 chars"),S.a.isEmpty(e.last_name)&&(t.last_name="Last name field is required"),S.a.isEmpty(e.first_name)&&(t.first_name="First name field is required"),S.a.isEmpty(e.username)&&(t.username="Username field is required"),S.a.isEmail(e.email)||(t.email="Email is invalid"),S.a.isEmpty(e.email)&&(t.email="Email is required"),S.a.isLength(e.password,{min:6,max:30})||(t.password="Password must have 6 chars"),S.a.isEmpty(e.password)&&(t.password="Password is required"),{errors:t,isValid:k(t)}}(t);if(!a)throw new E({data:r});if(await i.findOne({email:t.email}))throw new x({message:"email already exists",data:{email:"email already exists"}});{const e=new i(t),n=await w.a.genSalt(10),r=await w.a.hash(e.password,n);return e.ts_updated=Date.now(),e.password=r,e.save(),b(e,process.env.JWT_SECRET)}},login:async(e,t,n)=>{const{errors:r,isValid:a}=function(e){let t={};return e.email=k(e.email)?"":e.email,e.password=k(e.password)?"":e.password,S.a.isEmail(e.email)||(t.email="Email is invalid"),S.a.isEmpty(e.email)&&(t.email="Email is required"),S.a.isLength(e.password,{min:6,max:30})||(t.password="Password must have 6 chars"),S.a.isEmpty(e.password)&&(t.password="Password is required"),{errors:t,isValid:k(t)}}(t);if(!a)throw new E({data:r});const s=t.email,o=t.password,u=await i.findOne({email:s});if(u){if(await w.a.compare(o,u.password)){if(!process.env.JWT_SECRET)throw new v({message:"No jwt secret key"});return b(u,process.env.JWT_SECRET)}return new E({message:"Incorrect Password"})}throw new E({message:"user not found"})},me:async(e,t,n)=>{}},A=[{Mutation:{addUser:(e,t,n)=>O(P.add(e,t.input),n.user),deleteUser:async(e,t,n)=>O(P.del(e,t.id),n.user),updateUser:async(e,t,n)=>O(P.update(e,t),n.user),changePassword:async(e,t,n)=>O(P.changePassword(e,t,n),n.user),changeMyPassword:async(e,t,n)=>O(P.changeMyPassword(e,t,n),n.user),updateMe:async(e,t,n)=>O(P.updateMe(e,t,n),n.user),login:async(e,t)=>P.login(e,t.input),signup:async(e,t,n)=>"true"===process.ENV.SIGNUP?P.signup(e,t.input,n):{token:"none",maxAge:"none"}},Query:{allUsers:(e,t,n)=>O(P.users(e,t),n.user),me:(e,t,n)=>n.user}}],q=[{Mutation:{},Query:{getHello:(e,t,n)=>({y:"mini hello"})}}],B=n(4),R=n.n(B),M=n(13),j=n.n(M);const C=new a.a.Schema({user:{type:a.a.Schema.Types.ObjectId,ref:"User"},code:{type:String,default:()=>(e=>{let t="";for(;t.length<e;)t+=Math.random().toString(36).substring(2,15);return t.substring(0,e)})(64)},expires:{type:Date,default:()=>Date.now()+1e3*(Number(process.env.TIME_TO_LOGIN)||120)},ts_created:{type:Date,default:Date.now},use_to_login:{type:Boolean,default:!1},provider:String},{toObject:{virtuals:!0},toJson:{virtuals:!0}});C.virtual("is_valid").get((function(){return Date.now()<=this.expires})),C.methods.login=function(){return!(!this.is_valid||!this.use_to_login)&&(this.use_to_login=!1,this.save(),!0)},C.pre("save",(function(){console.log("pre save setter",this)}));var N=a.a.model("setters",C);var H={all:(e,t)=>N.find({}),login:async(e,{code:t})=>{let n=await N.findOne({code:t});if(n&&n.login()){n=await i.populate(n,{path:"user",model:i});const e=b(n.user);return N.deleteOne({code:t}),e}throw new E({message:"Wrong authorization code"})},get:(e,{id:t})=>N.findById(t),add:(e,{input:t})=>new N(t).save(),delete:async(e,{id:t})=>(await N.deleteOne({_id:t},e=>{if(e)return!1}),!0),update:async(e,{input:t,id:n})=>{const r={input:t},a=await N.findByIdAndUpdate(n,{$set:r},{new:!0});if(a)return a;throw new U},clean:async e=>{await N.deleteMany({expires:{$lte:Date.now()}})}};class L{constructor(e={},t={},n=!0){this.config=e,this.context=t,this.authData={},this.authData.refresh_token=this.context.refresh_token,this.isLogin=n}async init(){this.context.state&&this.getUserSetter(),this.context.authorizationCode&&await this.postTokenRequest(),this.context.refresh_token&&await this.postTokenRequest()}getRedirectUri(){return this.config.auth.getRedirectUri(this.currentUser,this.context.state)}authorizeFullPath(){return this.config.auth.authorizeHost+this.config.auth.authorizePath}tokenFullPath(){return this.config.auth.tokenHost+this.config.auth.tokenPath}getAuthorizationUriParameters(e=null){return{response_type:"code",client_id:this.config.client.id,redirect_uri:this.config.auth.authorizeRedirectUri,scope:"object"==typeof this.config.auth.scope?this.config.auth.scope.join("+"):this.config.auth.scope,access_type:this.config.auth.accessType,state:e}}getAuthorizationUri(e=null){const t=j.a.stringify(this.getAuthorizationUriParameters(e)).replace(/%2B/g,"+");return this.authorizeFullPath()+"?"+t}postTokenRequestParameters(e=null,t=null,n=null){return{grant_type:e?"authorization_code":"refresh_token",refresh_token:e?null:n,code:e||null,redirect_uri:e?this.config.auth.authorizeRedirectUri:null,client_id:this.config.client.id,client_secret:this.config.client.secret,scope:"object"==typeof this.config.auth.scope?this.config.auth.scope.join(" "):this.config.auth.scope,state:t}}async postTokenRequest(){const{authorizationCode:e,refresh_token:t,state:n}=this.context,r={method:"POST",uri:this.tokenFullPath(),json:!0,body:t?this.postTokenRequestParameters({refresh_token:t}):this.postTokenRequestParameters(e,n)},{expires_in:a,token_type:s,access_token:o,refresh_token:i,scope:u}=await R()(r);this.authData={...this.authData,refresh_token:i,provider:this.config.auth.authorizeHost,email:"",scope:u,provider:this.config.provider,expires:Date.now()+1e3*a,access_token:o,token_type:s}}async getUserSetter(){if(this.context.state){const e=await N.findOne({code:this.context.state}).populate({path:"user",model:i});this.context.setter=e,N.deleteOne({code:this.context.u})}else this.context.setter={}}async revokeToken(e){return await R()({method:"GET",url:this.conf.tokenInvalidationUri(e),body:""}),0}async getProfile(){this.authData={...this.authData,...await R()({uri:this.config.profileApi,method:"GET",headers:{Authorization:"Bearer "+this.authData.access_token},json:!0})}}async useStrategy(){if(this.isLogin){const{scope:e,refresh_token:t,access_token:n,picture:r,locale:a,name:s,expires:o,email:u,email_verified:c,provider:l,given_name:d,family_name:p}=this.authData;if(this.currentUser=await i.findOneAndUpdate({"oauth2.email":u},{$set:{"oauth2.$[el].scope":e,"oauth2.$[el].refresh_token":t,"oauth2.$[el].access_token":n,"oauth2.$[el].picture":r,"oauth2.$[el].locale":a,"oauth2.$[el].name":s,"oauth2.$[el].expires":o}},{arrayFilters:[{"el.email":u}],returnNewDocument:!0}),this.currentUser);else if(process.env.SIGNUP){this.currentUser=new i({email:u,email_verified:c,picture:r,first_name:d,last_name:p,oauth2:[]});const h={scope:e,refresh_token:t,access_token:n,picture:r,locale:a,name:s,expires:o,email:u,email_verified:c,provider:l};this.currentUser.oauth2.push(h),await this.currentUser.save(),this.isSignup=!0}return this.context.setter=this.context.setter?await H.update({},{code:this.context.setter.code,input:{user:this.currentUser,use_to_login:!0}}):await H.add({},{input:{user:this.currentUser,use_to_login:!0,provider:"google"}}),this.context.state=this.context.setter.code,this.getRedirectUri()}TODO;const{user:e}=this.context.setter}}"true"===process.env.LOCAL&&n(8).config();const{GOOGLE_OAUTH_CLIENT:z,GOOGLE_OAUTH_KEY:G,GOOGLE_OAUTH_HOST_AUTHORIZE:$,GOOGLE_OAUTH_HOST_TOKEN:F}=process.env;var J={provider:"google",timeToLogin:120,client:{id:z,secret:G},auth:{authorizeHost:"https://accounts.google.com",authorizePath:"/o/oauth2/auth",tokenHost:"https://oauth2.googleapis.com",tokenPath:"/token",scope:["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email"],accessType:"online",authorizeRedirectUri:$+"/auth/google/callback",getRedirectUri:(e,t)=>e.is_active?`${F}/redeem/${t}`:F+"/fail"},tokenInvalidationUri:e=>"https://accounts.google.com/o/oauth2/revoke?token="+e,profileApi:"https://www.googleapis.com/oauth2/v3/userinfo"};process.env.LOCAL&&n(8).config();var W=(e,t,n)=>new L({...J,...e},t,n),Q=[...A,...q,...[{Mutation:{oAuth2Login:async(e,t)=>await H.login(e,t)},Query:{async oAuth2Google(e,t,n){const r=W();H.clean();return r.getAuthorizationUri(null)}}},{Mutation:{addSetter:(e,t,n)=>O(H.add(e,t),n.user),deleteSetter:async(e,t,n)=>O(H.del(e,t),n.user),updateSetter:async(e,t,n)=>O(H.update(e,t),n.user)},Query:{allSetters:(e,t,n)=>O(H.all(e,t),n.user),getSetter:(e,t,n)=>O(H.get(e,t),n.user)}}]],V=Object(g.makeExecutableSchema)({typeDefs:m,resolvers:Q}),K=n(14),Y=n(9),Z=n.n(Y),X=n(7),ee=n.n(X),te=n(15),ne=n.n(te);const re=n(9).Router();re.get("/:setter/callback",async(e,t)=>{const{state:n,scope:r,code:a}=e.query;if(r&&a||t.status(400).send("Bad request"),"google"===e.params.setter){const e=W({},{state:n,authorizationCode:a});await e.init(),await e.getProfile();const r=await e.useStrategy();t.redirect(r)}});var ae=re,se=n(16);process.env.LOCAL&&n(8).config();const{DB_DEBUG:oe,DB_HOST:ie,DB_USER:ue,DB_NAME:ce,DB_PASSWORD:le,DEBUG:de,CORS:pe,JWT_SECRET:he}=process.env;let ge;const me="true"===de,fe="true"===oe,we="true"===pe;if(me){a.a.connection.once("open",()=>{console.log("connected to database at ",a.a.connection.host+a.a.connection.port+"/"+a.a.connection.name)}),ge={endpoint:"/graphql",settings:{"editor.theme":"dark"}}}fe&&a.a.set("debug",!0),a.a.set("useFindAndModify",!1),a.a.connect(`mongodb+srv://${ue}:${le}@${ie}/${ce}?retryWrites=true`,{useNewUrlParser:!0});const ye=new K.ApolloServer({schema:V,playground:ge,cors:we,introspection:me,tracing:!0,debug:me,formatError:void 0,formatResponse:void 0,cacheControl:{},extensions:[()=>new se.CacheControlExtension({defaultMaxAge:604800,calculateHttpHeaders:!0})],context:async({req:e})=>{let t={};const n=e.headers.authorization?e.headers.authorization.split(" ")[1]:"";if(n){let e={expiresIn:process.env.SESSION_DURATION,algorithm:["RS256"]},t="";try{t=D.a.verify(n,he,e)}catch(e){throw new I.AuthenticationError("must authenticate")}}return t.user=e.user,t.client={ip:e.headers.origin,ua:e.headers["user-agent"]},me&&console.log("Context : ",t),t}}),Se=Z()();Se.use("/",(e,t,n)=>{console.log(e.body),n()}),Se.use(ne()()),ee.a.use(h),Se.use(ee.a.initialize()),Se.use("/auth",ae),Se.use("/",(e,t,n)=>{console.log(e),ee.a.authenticate("jwt",{session:!1},(t,r,a)=>{r&&(e.user=r),n()})(e,t,n)}),ye.applyMiddleware({app:Se}),Se.listen({port:4e3},()=>console.log("ðŸŒ‹ Server ready at http://localhost:4000"+ye.graphqlPath))}]);